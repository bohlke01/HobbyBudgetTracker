---
name: Deploy to PythonAnywhere

on:
  push:
    branches: [main]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to PythonAnywhere
        env:
          PYTHONANYWHERE_USERNAME: ${{ secrets.PYTHONANYWHERE_USERNAME }}
          PYTHONANYWHERE_API_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
          PYTHONANYWHERE_DOMAIN: ${{ secrets.PYTHONANYWHERE_DOMAIN }}
        run: |
          # Check if required secrets are set
          if [ -z "$PYTHONANYWHERE_USERNAME" ] || [ -z "$PYTHONANYWHERE_API_TOKEN" ]; then
            echo "âš ï¸ PythonAnywhere secrets not configured. Skipping deployment."
            echo "To enable deployment, add the following secrets to your repository:"
            echo "  - PYTHONANYWHERE_USERNAME: Your PythonAnywhere username"
            echo "  - PYTHONANYWHERE_API_TOKEN: Your PythonAnywhere API token"
            echo "  - PYTHONANYWHERE_DOMAIN (optional): Your domain (e.g., username.pythonanywhere.com)"
            exit 0
          fi
          
          # Set domain default if not provided
          DOMAIN="${PYTHONANYWHERE_DOMAIN:-${PYTHONANYWHERE_USERNAME}.pythonanywhere.com}"
          
          echo "ðŸš€ Starting deployment to PythonAnywhere..."
          echo "ðŸ“ Target: https://${DOMAIN}"
          echo ""
          echo "â„¹ï¸  Note: This workflow reloads your web application."
          echo "   Make sure you have set up automatic code pulling on PythonAnywhere."
          echo "   See CONTINUOUS_DEPLOYMENT.md for setup instructions."
          echo ""
          
          # Reload the web app
          echo "ðŸ”„ Reloading web application..."
          RELOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Token ${PYTHONANYWHERE_API_TOKEN}" \
            "https://www.pythonanywhere.com/api/v0/user/${PYTHONANYWHERE_USERNAME}/webapps/${DOMAIN}/reload/")
          
          HTTP_CODE=$(echo "$RELOAD_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RELOAD_RESPONSE" | head -n-1)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Web application reloaded successfully!"
            echo "ðŸŒ Your app: https://${DOMAIN}"
            echo ""
            echo "âš ï¸  Important: If you haven't set up automatic code pulling,"
            echo "   your code changes won't be visible until you manually run:"
            echo "   git pull origin main"
            echo "   on your PythonAnywhere console."
          else
            echo "âš ï¸ Reload response code: $HTTP_CODE"
            echo "Response: $RESPONSE_BODY"
            echo "Reload may have failed. Please check your PythonAnywhere dashboard."
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.PYTHONANYWHERE_USERNAME }}" ]; then
            echo "âœ… Deployment workflow executed" >> $GITHUB_STEP_SUMMARY
            echo "- Target: PythonAnywhere" >> $GITHUB_STEP_SUMMARY
            echo "- Username: ${{ secrets.PYTHONANYWHERE_USERNAME }}" >> $GITHUB_STEP_SUMMARY
            echo "- Domain: ${{ secrets.PYTHONANYWHERE_DOMAIN || format('{0}.pythonanywhere.com', secrets.PYTHONANYWHERE_USERNAME) }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Deployment skipped - secrets not configured" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Setup Instructions:" >> $GITHUB_STEP_SUMMARY
            echo "1. Get your PythonAnywhere API token from: https://www.pythonanywhere.com/account/#api_token" >> $GITHUB_STEP_SUMMARY
            echo "2. Add the following secrets in your GitHub repository settings:" >> $GITHUB_STEP_SUMMARY
            echo "   - \`PYTHONANYWHERE_USERNAME\`: Your PythonAnywhere username" >> $GITHUB_STEP_SUMMARY
            echo "   - \`PYTHONANYWHERE_API_TOKEN\`: Your API token" >> $GITHUB_STEP_SUMMARY
            echo "   - \`PYTHONANYWHERE_DOMAIN\` (optional): Your domain if different from username.pythonanywhere.com" >> $GITHUB_STEP_SUMMARY
          fi
